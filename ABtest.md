# A/B тестирование
## Сценарий A/B тестирования
1. Определить целевую метрику.
2. Сформулировать статистическую гипотезу и критерий её проверки.
3. Зафиксировать минимальный ожидаемый эффект и допустимые вероятности ошибок I и II рода.
4. Оценить необходимый размер групп.
5. Сформировать экспериментальную и контрольную группу.
6. Провести эксперимент.
7. Оценить результаты эксперимента.

### Определить целевую метрику
Целевая метрика должна хорошо отражать конечную цель изменений, по ней будем оценивать успешность эксперимента.
### Сформулировать статистическую гипотезу и критерий её проверки
Будем проверять гипотезу о равенстве средних. Нулевая гипотеза - средние равны, альтернативная - средние не равны. В качестве критерия возьмём тест Стьюдента. Время эксперимента положим равным одной неделе.
### Зафиксировать минимальный ожидаемый эффект и допустимые вероятности ошибок I и II рода

>**Ошибка I рода** - это событие, заключающееся в том, что мы говорим, что эффект есть, когда его нет. 
>
>**Ошибка II рода** - это событие, заключающееся в том, что мы говорим, что эффекта нет, когда на самом деле он есть.

Вероятности ошибок I и II рода положим равными 0.05 и 0.20 соответственно. Допустим средняя выручка 2500 руб. и стандартное отклонение 800 руб. После рассылки писем будем ожидать, что выручка увеличится минимум на 100 руб.

### Оценить необходимый размер групп
Рассчитаем размер необходимой группы:

![](https://hsto.org/r/w1560/getpro/habr/upload_files/d11/7f3/45c/d117f345c74cea2d2811664b017afe91.png)

где \alpha- вероятность ошибки I рода, \beta- вероятность ошибки II рода, σ² - дисперсии значений в контрольной и экспериментальной группах, ε - минимальный ожидаемый эффект.

```python
import numpy as np    
from scipy import stats

alpha = 0.05                    # вероятность ошибки I рода
beta = 0.2                      # вероятность ошибки II рода
mu_control = 2500               # средняя выручка с пользователя в контрольной группе
effect = 100                    # размер эффекта
mu_pilot = mu_control + effect  # средняя выручка с пользователя в экспериментальной группе
std = 800                       # стандартное отклонение

t_alpha = stats.norm.ppf(1 - alpha / 2, loc=0, scale=1)
t_beta = stats.norm.ppf(1 - beta, loc=0, scale=1)
var = 2 * std ** 2
sample_size = int((t_alpha + t_beta) ** 2 * var / (effect ** 2))
print(f'sample_size = {sample_size}')
```
```python
sample_size = 1004
```
Проверим, что при таком размере групп вероятности ошибок контролируются на заданных уровнях. Это можно сделать с помощью синтетических AA и AB тестов. Будем генерировать пары выборок с эффектом и без эффекта и считать доли случаев, когда тест Стьюдента ошибся.

В данном примере для простоты генерируем данные из нормального распределения. На практике следует семплировать данные из эмпирического распределения, построенного на реальных исторических данных.
```python
first_type_errors = []
second_type_errors = []
 
sample_size = 1004
 
for _ in range(10000):
    control_one = np.random.normal(mu_control, std, sample_size)
    control_two = np.random.normal(mu_control, std, sample_size)
    
    pilot = np.random.normal(mu_pilot, std, sample_size)
    
    _, pvalue_aa = stats.ttest_ind(control_one, control_two)
    first_type_errors.append(pvalue_aa < alpha)
    
    _, pvalue_ab = stats.ttest_ind(control_one, pilot)
    second_type_errors.append(pvalue_ab >= alpha)

part_first_type_errors = np.mean(first_type_errors)
part_second_type_errors = np.mean(second_type_errors)

print(f'part_first_type_errors = {part_first_type_errors:0.3f}')
print(f'part_second_type_errors = {part_second_type_errors:0.3f}')
```
```python
part_first_type_errors = 0.052
part_second_type_errors = 0.200
```
Получили значения близкие к 0.05 и 0.2, как и должно было быть.

На практике точные значения параметров распределений неизвестны, вместо точных значений используются их оценки. Оценки параметров могут несколько отличаться от истинных значений, поэтому полученная оценка размера выборки не является абсолютно точной. Чтобы тест наверняка контролировал вероятности ошибок на заданном уровне, мы рекомендуем брать размер групп чуть больше рассчитанного значения.

Пусть размер групп будет равен 1100. Если запустить тот же скрипт с sample_size=1100, то оценка вероятности ошибки первого рода останется равной примерно 0.05, а второго рода уменьшится.

### Сформировать экспериментальную и контрольную группы
Мы определились с размером групп, теперь нужно выбрать конкретных пользователей для эксперимента. Это можно сделать случайным образом. Такой подход к формированию групп называется случайным семплированием.

Пусть у нас всего 10 тысяч пользователей, тогда выбрать людей для эксперимента можно следующим кодом
```python
user_ids = np.arange(10000)
control_user_ids, pilot_user_ids = np.random.choice(
    user_ids, (2, sample_size), replace=False
)
```
>**Ковариата - метрика, которая коррелирует с целевой метрикой, может быть измерена до эксперимента (строго говоря, нет) и не зависит от других экспериментов. В нашем случае факт регистрации в программе лояльности до эксперимента будет ковариатой.
Приведём несколько примеров ковариат для экспериментов с людьми: пол, возраст, город проживания, операционная система устройства пользователя. Если эксперимент проводится не на людях, а на магазинах, то ковариатами могут быть размер торговой площади, расположение (в торговом центре или в отдельном здании), режим работы (круглосуточный или нет) и так далее.

>**Популяция** - все пользователи, на которых мы можем повлиять нашим экспериментом. Пусть в нашей популяции будет 10 тысяч активных пользователей.

>С помощью **ковариат** можно разделить популяцию на непересекающиеся подмножества, которые будут обладать уникальным набором значений ковариат. Такие подмножества будем называть стратами.



## Провести эксперимент
Отправляем письма пользователям экспериментальной группы и ничего не отправляем пользователям контрольной группы. Ждём неделю.

## Оценить результаты эксперимента
Когда эксперимент закончен нужно собрать данные для расчёта метрик и провести проверку значимости отличий между группами по алгоритму, который мы зафиксировали до начала эксперимента.






**Источники:**

1. [Habr.com: Стратификация. Как разбиение выборки повышает чувствительность A/B теста](https://habr.com/ru/company/X5Tech/blog/596279/)
2. [Habr.com: Бутстреп и А/Б тестирование](https://habr.com/ru/company/X5Tech/blog/679842/)
3. [Habr.com: Проверка корректности А/Б тестов](https://habr.com/ru/company/X5Tech/blog/706388/)